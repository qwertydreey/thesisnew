<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chatbot</title>
    <!-- Bootstrap CSS -->
    <link 
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
        rel="stylesheet" 
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
        crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"> <!-- Font Awesome -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot.css') }}" />
</head>
<body>
  <!-- Chat Container -->
  <div class="chat-container shadow">
    <audio id="counticushelp" src="/static/sfx/counticushelp.mp3" preload="auto"></audio>
  
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
      <button onclick="history.back()" style="
        flex: 0 0 auto;
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 8px 16px;
        font-size: 14px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      " 
      onmouseover="this.style.backgroundColor='#45a049';" 
      onmouseout="this.style.backgroundColor='#4CAF50';">
        Back
      </button>
  
      <h5 style="color: white; flex: 1 1 auto; text-align: center; margin: 0;">
        Chat with Wizard Counticus
      </h5>
  
      <div style="flex: 0 0 auto;">
        <button id="clearChatBtn" onclick="clearChat()" style="
          background-color: #f44336;
          color: white;
          border: none;
          padding: 8px 16px;
          font-size: 14px;
          border-radius: 5px;
          cursor: pointer;
          transition: background-color 0.3s ease;
        "
        onmouseover="this.style.backgroundColor='#da190b';"
        onmouseout="this.style.backgroundColor='#f44336';"
        >
          Clear Chat
        </button>
      </div>
    </div>


    <div class="chat-messages" id="chat-box">
      <!-- Messages appear here -->
    </div>
    <form id="chat-form" class="d-flex mt-2">
      <input type="text" class="form-control me-2" id="user-input" placeholder="Type your message...">
      <button type="submit" class="btn btn-success">Send</button>
    </form>
    
    <!-- Voice Selection Dropdown -->
    <div class="voice-selector mt-3">
      <label for="voice-select">Choose a voice: </label>
      <select id="voice-select" class="form-select">
        <!-- Options will be added dynamically -->
      </select>
    </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Sample Chat Logic -->
    <script>
        // Check if page load is due to reload
        const navEntries = performance.getEntriesByType("navigation");
        const isReload = navEntries.length > 0 && navEntries[0].type === 'reload';
    
        // Clear sessionStorage chat only if it's reload
        if (isReload) {
            sessionStorage.removeItem('chatMessages');
        }
    
        // Load saved messages or start with empty array
        const savedMessages = sessionStorage.getItem('chatMessages');
        const messages = savedMessages ? JSON.parse(savedMessages) : [];
    
        const chatBox = document.getElementById('chat-box');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('user-input');
        const sendButton = form.querySelector('button');
        const voiceSelect = document.getElementById('voice-select');
    
        let currentUtterance = null;
        let selectedVoice = null;
    
        function saveMessagesToStorage() {
            sessionStorage.setItem('chatMessages', JSON.stringify(messages));
        }
    
        // Render messages so newest pairs are on top, grouped as user+bot pairs
        function renderMessages() {
    chatBox.innerHTML = '';

    for (let i = messages.length - 1; i >= 0; i -= 2) {
        const pairContainer = document.createElement('div');
        pairContainer.classList.add('conversation-pair');

        // bot message (if exists)
        if (i - 1 >= 0) {
            const botMsg = createMessageRow(messages[i - 1].text, messages[i - 1].sender);
            pairContainer.appendChild(botMsg);
        }

        // user message (if exists)
        if (i >= 0) {
            const userMsg = createMessageRow(messages[i].text, messages[i].sender);
            pairContainer.appendChild(userMsg);
        }

        chatBox.appendChild(pairContainer);
    }

    chatBox.scrollTop = chatBox.scrollHeight;
    saveMessagesToStorage();
}

    
        // Voice loading code unchanged
        function loadVoice() {
            const voices = speechSynthesis.getVoices();
            if (voices.length === 0) {
                setTimeout(loadVoice, 100);
                return;
            }
            voiceSelect.innerHTML = '';
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = voice.name;
                voiceSelect.appendChild(option);
            });
            const defaultVoice = voices.find(voice => voice.name.includes('Google US English')) || voices[0];
            selectedVoice = defaultVoice;
            voiceSelect.value = selectedVoice.name;
        }
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoice;
        }
        loadVoice();
    
        voiceSelect.addEventListener('change', () => {
            const voices = speechSynthesis.getVoices();
            selectedVoice = voices.find(voice => voice.name === voiceSelect.value);
        });
    
        // createMessageRow function unchanged, keep it here from your code
        function createMessageRow(message, sender) {
            const row = document.createElement('div');
            row.classList.add('message-row', sender);
    
            const profile = document.createElement('img');
            profile.classList.add('profile-pic');
            profile.src = sender === 'user'
                ? "{{ url_for('static', filename='images/chatbotimg/userpfp.png') }}"
                : "{{ url_for('static', filename='images/chatbotimg/counticuspfp.png') }}";
    
            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble');
    
            const messageText = document.createElement('span');
            messageText.textContent = message;
    
            bubble.appendChild(messageText);
    
            if (sender === 'bot') {
                const profileContainer = document.createElement('div');
                profileContainer.style.display = 'flex';
                profileContainer.style.flexDirection = 'column';
                profileContainer.style.alignItems = 'center';
                profileContainer.style.gap = '4px';
    
                profileContainer.appendChild(profile);
    
                const speakerIcon = document.createElement('i');
                speakerIcon.classList.add('fas', 'fa-volume-up', 'speaker-icon', 'bot');
                speakerIcon.title = "Read aloud";
                speakerIcon.style.fontSize = '20px';
                speakerIcon.style.cursor = 'pointer';
    
                speakerIcon.addEventListener('click', () => {
                    if (currentUtterance && speechSynthesis.speaking) {
                        speechSynthesis.cancel();
                        currentUtterance = null;
                    } else {
                        const utterance = new SpeechSynthesisUtterance(message);
                        if (selectedVoice) {
                            utterance.voice = selectedVoice;
                        }
                        utterance.rate = 0.9;
                        utterance.pitch = 1;
                        currentUtterance = utterance;
                        speechSynthesis.speak(utterance);
                    }
                });
    
                profileContainer.appendChild(speakerIcon);
    
                row.appendChild(profileContainer);
                row.appendChild(bubble);
            } else {
                row.appendChild(bubble);
                row.appendChild(profile);
            }
    
            bubble.style.position = 'relative';
    
            return row;
        }
    
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
    
            const userText = input.value.trim();
            if (!userText) return;
    
            if (currentUtterance && speechSynthesis.speaking) {
                speechSynthesis.cancel();
                currentUtterance = null;
            }
    
            input.disabled = true;
            sendButton.disabled = true;
    
            // Add user message
            messages.push({ sender: 'user', text: userText });
            renderMessages();
    
            // Add "thinking" bot message
            messages.push({ sender: 'bot', text: "Hmm... let me think about that!" });
            renderMessages();
    
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;
    
            try {
                const response = await fetch('/chatbot-api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userText })
                });
                const data = await response.json();
    
                // Replace the "thinking" message with actual reply
                messages.pop();
                messages.push({ sender: 'bot', text: data.reply });
                renderMessages();
            } catch (error) {
                messages.pop();
                messages.push({ sender: 'bot', text: "Oops! Counticus couldn't reach the magic scrolls üßô‚Äç‚ôÇÔ∏èüìú." });
                renderMessages();
            } finally {
                input.disabled = false;
                sendButton.disabled = false;
            }
        });
    
        // Initial render on page load
        renderMessages();
    

        function clearChat() {
  // Clear messages array
  messages.length = 0;

  // Clear sessionStorage
  sessionStorage.removeItem('chatMessages');

  // Clear the chat box UI
  chatBox.innerHTML = '';

  // Optionally, disable speech synthesis if speaking
  if (speechSynthesis.speaking) {
    speechSynthesis.cancel();
  }
}

    </script>
    


<script>
    let hasPlayedCounticus = false;
  
    function counticushelp() {
      const sound = document.getElementById('counticushelp');
  
      // Only play if not already playing and hasn't played before
      if (!hasPlayedCounticus && sound.paused) {
        sound.currentTime = 0;
        sound.volume = 1;
        sound.play().then(() => {
          hasPlayedCounticus = true;
        }).catch((e) => {
          console.error('Playback failed:', e);
        });
      }
    }
  
    // Play once on first interaction anywhere
    ['click', 'keydown', 'touchstart'].forEach(event => {
      document.addEventListener(event, counticushelp, { once: true });
    });
  </script>
  
</body>
</html>
